# CanvasKit Web Integration

This document explains how CanvasKit is integrated into the CMEWS app to enable Skia charts on the web platform.

## Overview

The app uses React Native Skia for hardware-accelerated chart rendering. On iOS and Android, Skia works natively. On web, it requires CanvasKit (a WebAssembly build of Skia) to be loaded.

## Architecture

### Components

1. **`lib/canvaskit-loader.ts`** - CanvasKit loading utility
   - Singleton pattern ensures CanvasKit loads only once
   - Platform detection: auto-loads on web, instant on native
   - Provides `useCanvasKitLoader()` React hook

2. **`components/charts/SmartChartWrapper.tsx`** - Intelligent wrapper
   - Wraps all Skia chart components
   - Handles loading states on web
   - Zero overhead on native platforms

3. **`/public/canvaskit.wasm`** - WebAssembly binary
   - 7.7MB CanvasKit WASM file
   - Auto-generated by `npx setup-skia-web`
   - Excluded from git (build artifact)

### How It Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Platform Detection                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                           â”‚
         iOS/Android                     Web
              â”‚                           â”‚
              â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Native Skia     â”‚      â”‚  Load CanvasKit      â”‚
    â”‚  (instant)       â”‚      â”‚  (async, ~2-3s)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚
              â”‚                           â–¼
              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚  Show Loading UI     â”‚
              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚
              â”‚                           â–¼
              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚  CanvasKit Ready     â”‚
              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Render Skia Charts      â”‚
              â”‚  (60fps, identical)      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Usage

### Basic Usage

```tsx
import { SmartChartWrapper } from '~/components/charts';
import { SkiaTemperatureChart } from '~/components/charts';

function MyComponent() {
  return (
    <SmartChartWrapper height={220} loadingMessage="Loading chart...">
      <SkiaTemperatureChart data={chartData} />
    </SmartChartWrapper>
  );
}
```

### Custom Error Handling

```tsx
<SmartChartWrapper 
  height={220}
  errorFallback={
    <View className="p-4">
      <Text>Unable to load charts. Please refresh.</Text>
    </View>
  }
>
  <SkiaChart data={data} />
</SmartChartWrapper>
```

## Implementation Details

### Conditional Import Pattern

The SmartChartWrapper uses a conditional require to prevent bundler issues:

```tsx
// Only import canvaskit-loader on web to avoid Node.js dependencies on native
let useCanvasKitLoader: any;
if (Platform.OS === 'web') {
  const loaderModule = require('~/lib/canvaskit-loader');
  useCanvasKitLoader = loaderModule.useCanvasKitLoader;
}
```

This prevents the bundler from trying to include Node.js-specific code (like `fs` module) when building for iOS/Android.

### Dynamic Import for CanvasKit

The loader uses dynamic import to load CanvasKit at runtime:

```typescript
const { LoadSkiaWeb } = await import(
  /* webpackChunkName: "skia-web" */
  '@shopify/react-native-skia/lib/module/web'
);
```

This ensures CanvasKit is code-split and loaded on-demand.

### WASM File Location

The CanvasKit WASM file is served from the root:

```typescript
await LoadSkiaWeb({
  locateFile: (file: string) => {
    if (file.endsWith('.wasm')) {
      return `/canvaskit.wasm`; // Served from /public/canvaskit.wasm
    }
    return file;
  },
});
```

## Performance Characteristics

| Platform | Initial Load | Chart Render | Subsequent Loads |
|----------|-------------|--------------|------------------|
| iOS      | Instant     | 60fps        | Instant          |
| Android  | Instant     | 60fps        | Instant          |
| Web (1st)| +2-3 sec    | 60fps        | +2-3 sec         |
| Web (cached) | Instant | 60fps        | Instant          |

### Bundle Impact

- **Native platforms**: No change (0 bytes added)
- **Web platform**: 
  - CanvasKit WASM: 7.7 MB (loaded on-demand)
  - Loader code: ~3 KB (included in bundle)
  - Total impact: Minimal (lazy loaded)

## Build Process

### Setup CanvasKit WASM

```bash
npx setup-skia-web
# or use npm script
npm run setup:web
```

This creates `/public/canvaskit.wasm` (7.7MB). The file is:
- Excluded from git (in `.gitignore`)
- Copied to `/dist/canvaskit.wasm` during build
- Served as a static asset

### Verification

Verify your setup is correct:

```bash
npm run verify:web
```

This runs an automated check script that verifies:
- âœ… CanvasKit WASM file exists and has correct size (~7.7MB)
- âœ… Required dependencies installed (@shopify/react-native-skia, react-native-reanimated)
- âœ… Required files present (SmartChartWrapper, canvaskit-loader)
- âœ… Metro bundler configured correctly

**Expected output:**
```
ğŸ” Verifying CMEWS Web Platform Setup...

1. Checking CanvasKit WASM file...
   âœ“ Found: public/canvaskit.wasm (7.7M)

2. Checking dependencies...
   âœ“ React Native Skia installed
   âœ“ React Native Reanimated installed

3. Checking required files...
   âœ“ Found: components/charts/SmartChartWrapper.tsx
   âœ“ Found: lib/canvaskit-loader.ts
   âœ“ Found: app.json

4. Checking configuration...
   âœ“ Metro bundler configured for web

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ“ All checks passed!
```

### Build Commands

```bash
# Setup web platform (first time)
npm run setup:web

# Verify setup
npm run verify:web

# Development server
npm run web

# Build for web only
npm run build:web

# Build for all platforms
npm run build
```

## Troubleshooting

### Charts Don't Load on Web

1. **Run verification script**:
   ```bash
   npm run verify:web
   ```
   This will identify any missing setup steps.

2. **Check CanvasKit WASM exists**:
   ```bash
   ls -lh public/canvaskit.wasm
   ```
   Should show 7.7MB file

3. **Regenerate if missing**:
   ```bash
   npm run setup:web
   # or
   npx setup-skia-web
   ```

4. **Check browser console** for loading errors

### Build Errors on Native

If you see `fs` module errors when building for iOS/Android:
- Verify SmartChartWrapper uses conditional require
- Check that canvaskit-loader is not imported at top level on native

### Performance Issues on Web

- **First load slow**: Normal (CanvasKit downloading)
- **Cached loads slow**: Check browser network tab, WASM should be cached
- **Charts laggy**: May indicate CanvasKit failed to load, check console

## Migration Guide

### From Old Pattern (Disabled Charts on Web)

**Before:**
```tsx
// Charts were disabled on web with fallback messages
{Platform.OS === 'web' ? (
  <Text>Charts not available on web</Text>
) : (
  <SkiaChart data={data} />
)}
```

**After:**
```tsx
// Charts work everywhere with smart loading
<SmartChartWrapper>
  <SkiaChart data={data} />
</SmartChartWrapper>
```

### From ECharts

**Before:**
```tsx
import ECharts from 'react-native-echarts-wrapper';
// ECharts configuration...
```

**After:**
```tsx
import { SkiaTemperatureChart, SmartChartWrapper } from '~/components/charts';

<SmartChartWrapper>
  <SkiaTemperatureChart data={chartData} />
</SmartChartWrapper>
```

## Testing

### Manual Testing Checklist

#### Web Platform
- [ ] Charts show loading state on first render
- [ ] Charts render correctly after CanvasKit loads
- [ ] Animations are smooth (60fps)
- [ ] No console errors
- [ ] Charts work on subsequent page visits (cached)

#### Native Platforms
- [ ] Charts render immediately (no loading state)
- [ ] Animations are smooth (60fps)
- [ ] No bundler warnings about missing modules
- [ ] App size unchanged

### Browser Compatibility

CanvasKit/Skia works on all modern browsers that support WebAssembly:
- âœ… Chrome 57+
- âœ… Firefox 52+
- âœ… Safari 11+
- âœ… Edge 16+

## Resources

- [React Native Skia Documentation](https://shopify.github.io/react-native-skia/)
- [Skia Web Setup Guide](https://shopify.github.io/react-native-skia/docs/getting-started/web)
- [CanvasKit Documentation](https://skia.org/docs/user/modules/canvaskit/)

## License

Same as parent project (MIT)
